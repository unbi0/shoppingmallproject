<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Page</title>
    <link rel="stylesheet" href="account-update.css">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/my')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('email').value = data.email;
                    document.getElementById('username').value = data.username;
                    document.getElementById('postcode').value = data.address.postcode;
                    document.getElementById('address').value = data.address.address;
                    document.getElementById('detailAddress').value = data.address.detailAddress;
                })
                .catch(error => console.error('Error:', error));
        });
        function daumPost() {
            new daum.Postcode({
                oncomplete: function(data) {
                    let addr = ''; // 주소 변수
                    if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                        addr = data.roadAddress;
                    } else { // 사용자가 지번 주소를 선택했을 경우(J)
                        addr = data.jibunAddress;
                    }
                    document.getElementById('postcode').value = data.zonecode;
                    document.getElementById('address').value = addr;
                    document.getElementById('detailAddress').focus();
                }
            }).open();
        }
        function handleSubmit(event) {
            event.preventDefault();

            const address = {
                postcode: document.getElementById('postcode').value,
                address: document.getElementById('address').value,
                detailAddress: document.getElementById('detailAddress').value
            };

            const data = {
                username: document.getElementById('username').value,
                address: address
            };

            fetch('/user', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        alert('회원정보가 수정되었습니다.');
                        location.href = '/index.html'; // 수정 후 메인 페이지로 리다이렉션
                    } else {
                        alert('회원정보 수정에 실패하였습니다.');
                    }
                });
        }

        function handleDelete(event) {
            event.preventDefault();

            fetch('/user', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert('회원 탈퇴가 완료되었습니다.');
                        location.href = '/index.html'; // 탈퇴 후 메인 페이지로 리다이렉션
                    } else {
                        alert('회원 탈퇴에 실패하였습니다.');
                    }
                });
        }
    </script>
</head>
<body>
<div class="container">
    <h1>내 정보 수정</h1>
    <form id="signupForm" onsubmit="handleSubmit(event)">
        <div class="form-group">
            <input type="email" id="email" name="email" placeholder="이메일" readonly>
        </div>
        <div class="form-group">
            <input type="password" id="cipherPassword" name="cipherPassword" placeholder="비밀번호">
        </div>
        <div class="form-group">
            <input type="password" id="confirm" name="confirm" placeholder="비밀번호 확인">
        </div>
        <div class="form-group">
            <input type="text" id="username" name="username" placeholder="이름" required>
        </div>
        <div class="form-group postcode-group">
            <input type="text" id="postcode" name="postcode" placeholder="우편번호" readonly="readonly">
            <input type="button" onclick="daumPost()" value="주소 찾기">
        </div>
        <div class="form-group">
            <input type="text" id="address" name="address" placeholder="기본 주소">
        </div>
        <div class="form-group">
            <input type="text" id="detailAddress" name="detailAddress" placeholder="상세 주소">
        </div>
        <div class="button-group">
            <button type="submit">회원정보수정</button>
            <button type="button" onclick="location.href='/index.html'">수정 취소</button>
            <button type="button" onclick="handleDelete(event)">회원 탈퇴</button>
        </div>
    </form>
</div>
</body>
</html>
